using System;
using System.IO;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace Ficha_Tecnica.Services;

public class SignatureMalwareScanner : IMalwareScanner
{
    private static readonly byte[] EicarSignature = Encoding.ASCII.GetBytes(
        "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*");

    public async Task<MalwareScanResult> ScanAsync(
        Stream fileStream,
        MalwareScanContext context,
        CancellationToken cancellationToken = default)
    {
        if (fileStream is null)
        {
            throw new ArgumentNullException(nameof(fileStream));
        }

        _ = context;

        using var buffer = new MemoryStream();
        await fileStream.CopyToAsync(buffer, cancellationToken);

        if (ContainsSignature(buffer.ToArray()))
        {
            return MalwareScanResult.Malicious(
                "EICAR-Test-File",
                "The upload matches the EICAR antivirus signature.");
        }

        return MalwareScanResult.Clean();
    }

    private static bool ContainsSignature(ReadOnlySpan<byte> data)
    {
        return data.IndexOf(EicarSignature) >= 0;
    }
}
