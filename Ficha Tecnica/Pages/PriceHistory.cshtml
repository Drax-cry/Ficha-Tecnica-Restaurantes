@page "/PriceHistory"
@model Ficha_Tecnica.Pages.PriceHistoryModel
@using System.Globalization
@using Ficha_Tecnica.Models
@{
    ViewData["Title"] = "Histórico de Preços";
    ViewData["BodyClass"] = "price-history-page";
}

<section class="price-history" aria-labelledby="price-history-title">
    <header class="price-history-hero">
        <div class="price-history-intro">
            <p class="price-history-eyebrow" data-i18n-en="Ingredient trends">Tendências por ingrediente</p>
            <h1 id="price-history-title" data-i18n-en="Price history">Histórico de preços</h1>
            <p class="price-history-description" data-i18n-en="Record adjustments and track how ingredient costs evolve over time.">
                Registre reajustes e acompanhe como os custos dos insumos evoluíram ao longo do tempo.
            </p>
            @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
            {
                <p class="price-history-status" role="status" data-i18n-en="@Model.StatusMessageEn ?? Model.StatusMessage">@Model.StatusMessage</p>
            }
        </div>
        <form class="price-history-filters" method="get" aria-label="Filtrar histórico de preços" data-i18n-target="aria-label" data-i18n-en="Filter price history">
            <div class="filter-group">
                <label asp-for="IngredientId" data-i18n-en="Ingredient">Ingrediente</label>
                <select asp-for="IngredientId">
                    @foreach (var option in Model.IngredientFilterOptions)
                    {
                        <option value="@option.Value" data-i18n-en="@option.TextEn" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label asp-for="StartDate" data-i18n-en="From">De</label>
                <input asp-for="StartDate" type="date" />
            </div>
            <div class="filter-group">
                <label asp-for="EndDate" data-i18n-en="Until">Até</label>
                <input asp-for="EndDate" type="date" />
            </div>
            <div class="filter-actions">
                <button type="submit" data-i18n-en="Apply filters">Aplicar filtros</button>
                <a class="filter-reset" href="/PriceHistory" data-i18n-en="Reset">Limpar</a>
            </div>
        </form>
    </header>

    <section class="price-history-summary" aria-label="Resumo de movimentações" data-i18n-target="aria-label" data-i18n-en="Adjustment summary">
        <article class="summary-card">
            <h2 data-i18n-en="Total changes">Total de alterações</h2>
            <p class="summary-value">@Model.Summary.TotalMovements</p>
            <p class="summary-description" data-i18n-en="Adjustments recorded in the selected period.">Movimentações registradas no período selecionado.</p>
        </article>
        <article class="summary-card">
            <h2 data-i18n-en="Average change">Variação média</h2>
            <p class="summary-value" data-i18n-en="@Model.Summary.AverageChangeDisplayEn">@Model.Summary.AverageChangeDisplay</p>
            <p class="summary-description" data-i18n-en="Average increase or decrease per adjustment.">Média de aumento ou redução por alteração.</p>
        </article>
        <article class="summary-card">
            <h2 data-i18n-en="Total increases">Somatório de altas</h2>
            <p class="summary-value summary-negative" data-i18n-en="@Model.Summary.TotalIncreaseDisplayEn">@Model.Summary.TotalIncreaseDisplay</p>
            <p class="summary-description" data-i18n-en="Cumulative cost increases.">Aumentos acumulados nos custos.</p>
        </article>
        <article class="summary-card">
            <h2 data-i18n-en="Total decreases">Somatório de quedas</h2>
            <p class="summary-value summary-positive" data-i18n-en="@Model.Summary.TotalDecreaseDisplayEn">@Model.Summary.TotalDecreaseDisplay</p>
            <p class="summary-description" data-i18n-en="Savings generated by price reductions.">Economia gerada pelas reduções de preço.</p>
        </article>
    </section>

    <section class="price-history-grid">
        <article class="price-history-panel" aria-labelledby="new-adjustment-title">
            <header>
                <h2 id="new-adjustment-title" data-i18n-en="Record adjustment">Registrar reajuste</h2>
                <p data-i18n-en="Enter the new price and keep the history up to date.">Informe o novo preço e mantenha o histórico sempre atualizado.</p>
            </header>
            <form method="post" asp-page-handler="AddMovement" class="price-history-form">
                <div asp-validation-summary="ModelOnly" class="validation-summary"></div>
                <div class="form-grid">
                    <div class="form-field">
                        <label asp-for="MovementInput.IngredientId" data-i18n-en="Ingredient"></label>
                        <select asp-for="MovementInput.IngredientId">
                            @foreach (var option in Model.MovementIngredientOptions)
                            {
                                <option value="@option.Value" data-i18n-en="@option.TextEn" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
                            }
                        </select>
                        <span asp-validation-for="MovementInput.IngredientId" class="validation-error"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="MovementInput.NewPrice" data-i18n-en="New price"></label>
                        <input asp-for="MovementInput.NewPrice" type="number" step="0.01" min="0" />
                        <span asp-validation-for="MovementInput.NewPrice" class="validation-error"></span>
                    </div>
                    <div class="form-field">
                        <label asp-for="MovementInput.EffectiveDate" data-i18n-en="Effective date"></label>
                        <input asp-for="MovementInput.EffectiveDate" type="date" />
                        <span asp-validation-for="MovementInput.EffectiveDate" class="validation-error"></span>
                    </div>
                </div>
                <div class="form-field">
                    <label asp-for="MovementInput.Notes" data-i18n-en="Notes"></label>
                    <textarea asp-for="MovementInput.Notes" rows="3" placeholder="Detalhe o motivo do reajuste ou acordos com fornecedores." data-i18n-target="placeholder" data-i18n-en="Detail the reason for the adjustment or agreements with suppliers."></textarea>
                    <span asp-validation-for="MovementInput.Notes" class="validation-error"></span>
                </div>
                <div class="form-actions">
                    <button type="submit" data-i18n-en="Save adjustment">Salvar reajuste</button>
                </div>
            </form>
        </article>

        <article class="price-history-panel" aria-labelledby="movements-title">
            <header>
                <h2 id="movements-title" data-i18n-en="Recent adjustments">Movimentações recentes</h2>
                <p data-i18n-en="View increases and decreases with full context.">Visualize aumentos e reduções com contexto completo.</p>
            </header>
            <div class="table-wrapper">
                <table class="price-history-table" aria-label="Tabela de reajustes recentes" data-i18n-target="aria-label" data-i18n-en="Table of recent adjustments">
                    <thead>
                        <tr>
                            <th scope="col" data-i18n-en="Ingredient">Ingrediente</th>
                            <th scope="col" data-i18n-en="Previous price">Preço anterior</th>
                            <th scope="col" data-i18n-en="New price">Novo preço</th>
                            <th scope="col" data-i18n-en="Change">Variação</th>
                            <th scope="col" data-i18n-en="% change">% variação</th>
                            <th scope="col" data-i18n-en="Effective on">Vigente em</th>
                            <th scope="col" data-i18n-en="Recorded on">Registrado em</th>
                            <th scope="col" data-i18n-en="Notes">Notas</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Movements.Count == 0)
                        {
                            <tr>
                                <td colspan="8" class="empty-state" data-i18n-en="No adjustments registered for the current filter.">Nenhum reajuste registrado para o filtro atual.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var movement in Model.Movements)
                            {
                                var directionClass = movement.Direction switch
                                {
                                    PriceMovementDirection.Increase => "movement-down",
                                    PriceMovementDirection.Decrease => "movement-up",
                                    _ => "movement-neutral"
                                };
                                <tr class="@directionClass">
                                    <td>
                                        <div class="movement-name">
                                            <strong>@movement.IngredientName</strong>
                                            <span>@movement.Unit</span>
                                        </div>
                                    </td>
                                    <td data-i18n-en="@movement.PreviousPriceDisplayEn">@movement.PreviousPriceDisplay</td>
                                    <td data-i18n-en="@movement.NewPriceDisplayEn">@movement.NewPriceDisplay</td>
                                    <td data-i18n-en="@movement.ChangeLabelEn">@movement.ChangeLabel</td>
                                    <td data-i18n-en="@movement.ChangePercentageLabelEn">@movement.ChangePercentageLabel</td>
                                    <td data-i18n-en="@movement.EffectiveDateDisplayEn">@movement.EffectiveDateDisplay</td>
                                    <td data-i18n-en="@movement.RecordedAtDisplayEn">@movement.RecordedAtDisplay</td>
                                    <td>
                                        @if (string.IsNullOrWhiteSpace(movement.Notes))
                                        {
                                            <span class="placeholder">—</span>
                                        }
                                        else
                                        {
                                            @movement.Notes
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </article>
    </section>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/price-history.js" asp-append-version="true"></script>
}
